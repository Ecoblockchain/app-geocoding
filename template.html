<! -- Fix for Bootstrap css with Google Maps https://github.com/twitter/bootstrap/issues/1552 -->
<style type="text/css">
    #map_canvas label {
        width: auto;
        display: inline;
    }
    #map_canvas img {
        max-width: none;
    }

    #throbber {
        position:absolute;
        z-index: 10000;
        width: 100px;
        height: 100px;
        margin-top: 105px;
        margin-left: 260px;
    }
</style>

<div class="row">
  <!-- Success and Error Messages for the user --> 
  <!-- Question, task id, photo and action buttons for answering the question-->
  <div class="span11 offset1">
    <div id="success" class="alert alert-success" style="display:none;">
      <a class="close">×</a>
      <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> All the tasks have been completed!</strong>
      <br/>
      <div class="alert-actions">
              <a class="btn small" href="/">Go back</a>
              <a class="btn small" href="/app">or, Check other applications</a>
      </div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
      <a class="close">×</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
    <div id="warning" class="alert alert-warning" style="display:none;">
      <a class="close">×</a>
      <strong>Oooops!</strong> City not found, trying with a new one!</strong>
    </div>
  </div>

  <div class="span11 offset1">
    <div id="question">
      <h1>Question</h1>
      <h3 id="city">City</h3>
      <p>Add a new marker (top right corner) to <i class="icon-map-marker"></i> to set the urban park position.</p> 
      <p>Task: <span id="task-id" class="label label-warning">#</span></p>
      <div id="map_canvas" style="width: 620px; height: 310px;">
          <div id="throbber"></div>
      </div>
      <div id="coordinates">
          <i class="icon-map-marker"></i> Urban park position: <strong> Longitude:</strong> <span id="lon"></span>, 
          <strong>Latitude:</strong> <span id="lat"></span>
      </div>
      <br/>
    </div>
    <div id="answer">
        <button class="btn btn-success" onclick="submitTask()"><i class="icon-check icon-white"></i> Save these coordinates for the urban park</button>
        <button class="btn" onclick="pybossa.newTask('urbanpark').done(function(data) {loadData(data)})">Try another city</button>
    </div>

  </div>
</div>
<script src="http://www.openlayers.org/api/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3.6&amp;sensor=false"></script>
<script src="https://raw.github.com/aino/throbber.js/master/throbber.js"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<!-- PyBossa interface -->
<script>
// Map for loading the markers and placing them
var map = null;
// Variable to geocode the points of interest: cities and urban parks
var geocoder;
// OpenLayers point variable to save the lon & lat
var point;
// Layer for placing the urban park marker. This layer allows drag & drop
var urbanParkLayer;
// Layer for placing the city. This layer is static and does not allow drag & drop, is just a reference.
var cityLayer;
// OpenLayers toolbar: adds the button to place the urban park marker
var toolbar;
// Spinner to give feedback to the user when the map is getting loaded or something is taking place in the background
var spinner = new Throbber({ 
    color: 'black',
    size: 90
});
// The spinner is attached to a div overlayed in top of the map. This div is only shown when the spinner is active, 
// otherwise, the div is hidden from the view to show the map.
spinner.appendTo (document.getElementById('throbber'));

// This function shows the spinner div and starts its animation
function spinnerStart() {
    $("#throbber").show();
    spinner.start();
}

// This function stops the spinner and hides the spinner div
function spinnerStop() {
    spinner.stop();
    $("#throbber").hide();
}

// This function creates the map, the layers, and sets up the map
function initialize() {

    map = new OpenLayers.Map('map_canvas');

    // Layers
    // Open Street Map (default layer)
    map.addLayer(new OpenLayers.Layer.OSM("Open Street Map"));

    // Google Maps Satellite layer
    map.addLayer(new OpenLayers.Layer.Google(
        "Google Satellite",
        {type: google.maps.MapTypeId.SATELLITE}
    ));

    // Google Maps Physical layer
    map.addLayer(new OpenLayers.Layer.Google(
        "Google Physical",
        {type: google.maps.MapTypeId.TERRAIN}
    ));

    // Icon for the City Marker
    var styleMapCity = new OpenLayers.StyleMap({
        pointRadius: 15,
        externalGraphic: 'http://dl.dropbox.com/u/27667029/mapicons/you-are-here-2.png'
    });

    // Icon for the Urban Park Marker 
    var styleMapUrbanPark = new OpenLayers.StyleMap({
        pointRadius: 15,
        externalGraphic: 'http://dl.dropbox.com/u/27667029/mapicons/urbanpark.png'
    });

    // Layer for placing the city marker
    cityLayer = new OpenLayers.Layer.Vector("City marker", {
        styleMap: styleMapCity,
        attribution: 'Marker Icons by <a href="http://mapicons.nicolasmollet.com/">Nicolas Mollet</a>'
    });
    map.addLayer(cityLayer);

    // Layer for placing the urban park marker
    urbanParkLayer = new OpenLayers.Layer.Vector("Urban park marker", {
        styleMap: styleMapUrbanPark,
        attribution: 'Marker Icons by <a href="http://mapicons.nicolasmollet.com/">Nicolas Mollet</a>'
    });
    map.addLayer(urbanParkLayer);

    // Function to allow only the addition of one urban park per city
    // The function gets the feature (point) and gets its location, transforms it to the right projection
    // loads the lon and at into the HTML skeleton and disables the toolbar, so no more points can be added
    disablePoint = function(feature) { 
        $("#lat").text(feature.geometry.y);
        var tmp = feature.geometry.clone();
        tmp.transform(
                map.getProjectionObject(), // from Spherical Mercator Projection
                new OpenLayers.Projection("EPSG:4326") // to transform from WGS 1984
        );
        $("#lon").text(tmp.x);       
        $("#lat").text(tmp.y);       
        toolbar.deactivate();
    }

    // Controls: Layer switcher and Mouse Position
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.addControl(new OpenLayers.Control.MousePosition({displayProjection: new OpenLayers.Projection("EPSG:4326")}));
    // This panel adds the control to add points into the map. The event featureAdded will trigger the disablePoint
    // function, that will disable the toolbar, so only one urban park marker can be added per city and per volunteer
    var panelControls = [
        new OpenLayers.Control.DrawFeature(urbanParkLayer,
            OpenLayers.Handler.Point,
            { 'displayClass': 'olControlDrawFeaturePoint',
              'featureAdded': disablePoint 
            })
    ];

    // Load the Editing Toolbar but only with the points tool
    toolbar = new OpenLayers.Control.Panel({
        displayClass: 'olControlEditingToolbar'
    });

    // Add all the previous controls to the map
    toolbar.addControls(panelControls);
    map.addControl(toolbar);

    // Default location to load the map
    var lonLat = new OpenLayers.LonLat(-0.1279688 ,51.5077286 )
        .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator Projection
        );

    // Enable drag & drop in the urban park Layer
    var drag = new OpenLayers.Control.DragFeature(urbanParkLayer, {
        onComplete: function() {
            var urbanParkPoint = urbanParkLayer.features[0].geometry
            var tmp = urbanParkPoint.clone();
            tmp.transform(
                    map.getProjectionObject(), // from Spherical Mercator Projection
                    new OpenLayers.Projection("EPSG:4326") // to transform from WGS 1984
            );
            // When the marker has been dropped, update the lon & lat of the urban park
            $("#lon").text(tmp.x);       
            $("#lat").text(tmp.y);       
        }
    
    });
    // Add the drag & drop control into the map
    map.addControl(drag);
    // Activate drag & drop
    drag.activate();
}

// Initialize the map
initialize();

// This function will load the marker of the city, and center the map on it
function addCity(city) {
    // As this action could take some time, start the spinner
    spinnerStart();
    // Geocode the city using Nominatim OSM service
    $.getJSON('http://nominatim.openstreetmap.org/search/' + city + '?format=json', function(output) {
        if (output.length >= 1) {
            //console.log("Lon: "+ output[0].lon + " Lat: " + output[0].lat);
            // Clean previous markers
            urbanParkLayer.removeAllFeatures();
            cityLayer.removeAllFeatures();
            // Activate the toolbar
            toolbar.activate();
            //console.log("Map cleaned!");
            // Create a LonLat object to load the city marker
            var lonLat = new OpenLayers.LonLat(output[0].lon, output[0].lat)
                .transform(
                    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
                    map.getProjectionObject() // to Spherical Mercator Projection
                );
            // Set the marker position
            point = new OpenLayers.Geometry.Point(lonLat.lon, lonLat.lat);
            cityLayer.addFeatures([new OpenLayers.Feature.Vector(point)]);
            // Center the map
            map.setCenter(lonLat,13);
            // Stop the spinner as the city marker has been loaded into the map
            spinnerStop();
            //lonLat.transform(
            //        map.getProjectionObject(), // from Spherical Mercator Projection
            //        new OpenLayers.Projection("EPSG:4326") // to transform from WGS 1984
            //);
            // Reset the lon & lat span objects
            $("#lon").text("-");
            $("#lat").text("-");
        }
        else {
            // City not found, sorry
            // Warn the user and try with another city
            $("#warning").fadeIn();
            setTimeout(function() {
                $("#warning").fadeOut();
                }, 2000);
                pybossa.newTask('urbanpark').done(function(data) {loadData(data)});
        }
    });
}

// Load the task data into the HTML skeleton
function loadData (data) {
    spinnerStart();
    $("#question h1").text(data.question);
    $("#question h3").text(data.task.info.city);
    $("#task-id").text(data.task.id);
    spinnerStop();

    addCity(data.task.info.city);
}

// Uses the new API method to get a proper task to be shown!
pybossa.newTask('urbanpark').done(function(data) { 
    //console.log(data);
    //addCity(data.task.city);
    loadData(data);
});

// Saves the answer for the given task
function submitTask() {
    lat = $("#lat").text();
    lon = $("#lon").text();
    urbanPark = { 'lat': lat, 'lon': lon};
    city = $("#city").text();
    task_id = $("#task-id").text();

    // Convert the feature location, the urban park marker position, into the GeoJSON format
    geojson = new OpenLayers.Format.GeoJSON({
        'internalProjection': map.baseLayer.projection,
        'externalProjection': new OpenLayers.Projection("EPSG:4326")
        });
    urbanPark = JSON.parse(geojson.write(urbanParkLayer.features[0]));
    //console.log(urbanPark.geometry.type);
    pybossa.saveTask( task_id, {'city': city, 'urbanpark': urbanPark}).done( function(data) {
        console.log(data); 
        console.log("Task saved!");
        // Request a new task
        pybossa.newTask('urbanpark').done( function(data) { loadData(data) });
    });
}
</script>

